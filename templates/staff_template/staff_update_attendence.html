{% extends 'staff_template/base_template.html' %}

{% block title %} View Update Attendance {% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center"><i class="fas fa-book"></i>  View Update Attendance </h2>
    
   
    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} text-center">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            <div class="form-group my-3">
                <label>Subject</label>
                <select class="form-control form-select" name="subject" id ="subject">
                    {% for subject in subjects %}
                    <option value="{{subject.id}}">{{subject.subject_name}}</option>
                    {% endfor %}

                </select>

            </div>
            <div class="form-group my-3">
                <label>Session Year</label>
                <select class="form-control form-select" name="session_year" id ="session_year">
                    {% for session_year in session_years %}
                    <option value="{{session_year.id}}">{{session_year.academic_start_year}} to {{session_year.academic_start_year}}</option>
                    {% endfor %}
                </select>

            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary w-100" id = "fetch_attendence"> Submit</button>

            </div>
           
            
            
            
        </div>
       
    </div>

    <br>
    <hr>
    <br>
    <div class="my-2">
      
        <div class="form-group form" id ="attendence_list">
            <div class="form-group my-3">
                <label>Submitted Attendences</label>
                <select class="form-control form-select" name="attendance_date" id ="attendance_dates">
                    <!-- {% for attendance_date in attendance_dates %}
                    <option value="{{attendance_date.id}}"></option>
                    {% endfor %} -->
                </select>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary w-100" id = "show_students"> Submit</button>

            </div>
            <div class="form-group" id ="students_list">

            </div>

           
        </div>
    </div>

    
   
</div>
{% endblock %}

{% block custom_js %}
<script>


document.addEventListener("DOMContentLoaded", function () {
    // Fetch students when the "Fetch Students" button is clicked
    document.getElementById("fetch_attendence").addEventListener("click", function () {
        var subject = document.getElementById("subject").value;
        var session_year = document.getElementById("session_year").value;

        // Prepare the data to send
        var data = new FormData();
        data.append("subject", subject);
        data.append("session_year_id", session_year);

        // Make an AJAX POST request to fetch students
        fetch("{% url 'get_attendence_dates' %}", {
            method: "POST",
            body: data,
        })
        .then(function (response) {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json(); // Assuming your backend returns JSON
        })
        .then(function (data) {
            data = JSON.parse(data)
            console.log(data); 
            displayAttendences(data); // Process and display the students data
        })
        .catch(function (error) {
            console.error("Error in Fetching Students:", error);
            alert("Error in Fetching Students");
        });
    });

 

    document.getElementById("show_students").addEventListener("click",function(e){
        alert("hello")
        var attDate = document.getElementById("attendance_dates").value;
        console.log(attDate)

        var data = new FormData();
        data.append("attendence_date", attDate);

        // Make an AJAX POST request to fetch students
        fetch("{% url 'get_attendence_students' %}", {
            method: "POST",
            body: data,
        })
        .then(function (response) {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json(); // Assuming your backend returns JSON
        })
        .then(function (data) {
            data = JSON.parse(data)
            console.log(data); 
            displayStudents(data); // Process and display the students data
        })
        .catch(function (error) {
            console.error("Error in Fetching Students:", error);
            alert("Error in Fetching Students");
        });

    })
});

// Function to display students
function displayAttendences(attendances) {
    // Get the output container
    var outputDiv = document.getElementById("attendance_dates");

    // Clear any existing content
    outputDiv.innerHTML = "";

    // Check if the students array is empty or invalid
    if (attendances.length === 0) {
        outputDiv.innerHTML = "<p>No attendence record found or invalid data received.</p>";
        return;
    }
    // Iterate over each student
    for (let i = 0; i < attendances.length; i++) {
        // Create a list item element
        const listItem = document.createElement("option");
        listItem.value = `${attendances[i].id}`
        listItem.innerHTML = `${attendances[i].date } : ${attendances[i].session_year}`
        

        outputDiv.appendChild(listItem);
    }


    // // Create and append the "Submit Attendance" button
    // const buttonSubmit = document.createElement("button");
    // buttonSubmit.id = "show_students";
    // buttonSubmit.type = 'button';
    // buttonSubmit.innerHTML = "Show Students";
    // buttonSubmit.className = "btn btn-success";
    // document.getElementById("attendence_list").append(buttonSubmit)
}
function displayStudents(data) {
    let outputDiv = document.getElementById("students_list");

    // Clear previous content
    outputDiv.innerHTML = "";

    // Create a line break for better formatting (optional)
    outputDiv.append(document.createElement("br"));

    // Create an unordered list to hold student items
    let list = document.createElement("ul");

    // Create or retrieve the "Update Attendance" button
    let updateButton = document.getElementById("update_attendance_button");
    if (!updateButton) {
        updateButton = document.createElement("button");
        updateButton.id = "update_attendance_button";
        updateButton.textContent = "Update Attendance";
        updateButton.style.marginTop = "10px";
        updateButton.style.display = "none"; // Hidden initially
        updateButton.addEventListener("click", () => {
            saveAttendance(data); // Save attendance on button click
        });
        outputDiv.appendChild(updateButton);
    }

    // Loop through the student data array
    for (let i = 0; i < data.length; i++) {
        // Create a list item for each student
        let listItem = document.createElement("li");
        listItem.innerHTML = `${data[i].student_id} : ${data[i].student_name} : ${data[i].status == 1 ? "Present" : "Absent"}`;
        listItem.id = `${data[i].student_id}`;

        // Create a checkbox to represent attendance status
        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `${data[i].student_id}`
        checkbox.checked = data[i].status == 1;

        // Add an event listener to detect changes
        checkbox.addEventListener("change", (event) => {
            data[i].status = event.target.checked ? 1 : 0; // Update status
            listItem.innerHTML = `${data[i].student_id} : ${data[i].student_name} : ${data[i].status == 1 ? "Present" : "Absent"}`;
            listItem.appendChild(checkbox); // Re-add the checkbox
            updateButton.style.display = "block"; // Show the button immediately on change
        });

        // Append the checkbox to the list item
        listItem.appendChild(checkbox);

        // Append the list item to the list
        list.appendChild(listItem);
    }

    // Append the complete list to the output div
    outputDiv.appendChild(list);
}



// function displayStudents(data) {
//     // Get the container where the students list will be displayed
//     let outputDiv = document.getElementById("students_list");
    
//     // Clear previous content (if any) to avoid appending repeatedly
//     outputDiv.innerHTML = "";

//     // Create a line break for better formatting (optional)
//     outputDiv.append(document.createElement("br"));

//     // Create an unordered list to hold student items
//     let list = document.createElement("ul");

//     // Loop through the student data array
//     for (let i = 0; i < data.length; i++) {
//         // Create a list item for each student
//         let listItem = document.createElement("li");

//         // Set the inner HTML with student details
//         listItem.innerHTML = `${data[i].student_id} : ${data[i].student_name} : ${data[i].status == 1 ? "Present" : "Absent"}`;
//         listItem.id = `${data[i].student_id}`;

//         // Create a checkbox to represent attendance status
//         let checkbox = document.createElement("input");
//         checkbox.type = "checkbox";
//         checkbox.checked = data[i].status == 1;

//         // Add an event listener to update the attendance status when checkbox is toggled
//         checkbox.addEventListener("change", (event) => {
//             data[i].status = event.target.checked ? 1 : 0; // Update status based on checkbox state
//             listItem.innerHTML = `${data[i].student_id} : ${data[i].student_name} : ${data[i].status == 1 ? "Present" : "Absent"}`;
//             listItem.appendChild(checkbox); // Re-add the checkbox to the updated list item
//         });

//         // Append the checkbox to the list item
//         listItem.appendChild(checkbox);

//         // Append the list item to the list
//         list.appendChild(listItem);
//     }

//     // Append the complete list to the output div
//     outputDiv.appendChild(list);
// }




function saveAttendance() {
    var students = document.querySelectorAll("input[type='checkbox']");
    var attendanceStudentData = [];

    // Loop through each checkbox to check if it's checked
    students.forEach(function (checkbox) {
        var studentId = checkbox.getAttribute('id') // Extract student ID from the value
        var attendanceStatus = checkbox.checked ? 1 : 0; // Set status to 1 if checked, 0 if unchecked

        // Add the student ID and attendance status to the data array
        attendanceStudentData.push({
            student_id: studentId,
            attendance_status: attendanceStatus
        });
    });

    var attendanceDate = document.getElementById("attendance_dates").value;
    var subjectId = document.getElementById("subject").value;
    var sessionYearId = document.getElementById("session_year").value;

    // Prepare the data to send
    var data = {
        attendance_date: attendanceDate,
        student_ids: attendanceStudentData,
        subject_id: subjectId,
        session_year_id: sessionYearId
    };

    // Now, attendanceData holds the values of the students marked as present or absent
    console.log("Attendance Data:", data);

    // Send the data to the server
    sendAttendanceData(data);
}
// Function to send attendance data to the server
function sendAttendanceData(attendanceData) {
    var data = new FormData();
    data.append("attendence_date", attendanceData.attendance_date);
    // JSON.stringify student_ids before sending
    data.append("student_ids", JSON.stringify(attendanceData.student_ids));  // Send student IDs as a JSON string
    data.append("subject_id", attendanceData.subject_id);
    data.append("session_year_id", attendanceData.session_year_id);

    fetch("{% url 'update_attendance_data' %}", {
        method: "POST",
        body: data,
    })
    .then(response => response.json())
    .then(responseData => {
        console.log("Attendance updated successfully:", responseData);
        alert("Attendance saved!");
    })
    .catch(error => {
        console.error("Error saving attendance:", error);
        alert("Error saving attendance");
    });
}


</script>


{% endblock %}
